<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/base :: html}">
<head>
    <th:block th:fragment="head-extra">
        <title>Advanced Search - Car Parts Marketplace</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.6.3/nouislider.min.css">
    </th:block>
</head>
<body>
    <div th:fragment="content">
        <!-- Advanced Search Header -->
        <section class="bg-primary text-white py-4">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 class="h3 mb-2">
                            <i class="fas fa-search-plus"></i> Advanced Search
                        </h1>
                        <p class="mb-0">
                            Find exactly what you need with our comprehensive search filters
                        </p>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <a th:href="@{/}" class="btn btn-outline-light">
                            <i class="fas fa-arrow-left"></i> Back to Home
                        </a>
                    </div>
                </div>
            </div>
        </section>

        <!-- Advanced Search Form -->
        <section class="py-5">
            <div class="container">
                <div class="row">
                    <!-- Search Filters Sidebar -->
                    <div class="col-lg-3">
                        <div class="card shadow-sm sticky-top" style="top: 20px;">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">
                                    <i class="fas fa-filter"></i> Search Filters
                                </h5>
                            </div>
                            <div class="card-body">
                                <form id="advancedSearchForm" th:action="@{/products/advanced-search}" method="get">
                                    <!-- Search Term -->
                                    <div class="mb-3">
                                        <label for="searchTerm" class="form-label">Search Term</label>
                                        <div class="position-relative">
                                            <input type="text" class="form-control" id="searchTerm" name="q" 
                                                   th:value="${currentSearch}" 
                                                   placeholder="Enter part name, number, or description..."
                                                   autocomplete="off">
                                            <div id="searchSuggestions" class="position-absolute w-100 bg-white border rounded shadow-sm" 
                                                 style="top: 100%; left: 0; z-index: 1000; display: none; max-height: 200px; overflow-y: auto;">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Category Filter -->
                                    <div class="mb-3">
                                        <label for="categoryId" class="form-label">Category</label>
                                        <select class="form-select" id="categoryId" name="categoryId">
                                            <option value="">All Categories</option>
                                            <option th:each="cat : ${categories}" 
                                                    th:value="${cat.id}" 
                                                    th:text="${cat.name}"
                                                    th:selected="${cat.id == currentCategoryId}">
                                                Category Name
                                            </option>
                                        </select>
                                    </div>

                                    <!-- Condition Filter -->
                                    <div class="mb-3">
                                        <label for="condition" class="form-label">Condition</label>
                                        <select class="form-select" id="condition" name="condition">
                                            <option value="">All Conditions</option>
                                            <option th:each="cond : ${conditions}" 
                                                    th:value="${cond.name()}" 
                                                    th:text="${cond.name()}"
                                                    th:selected="${cond.name() == currentCondition}">
                                                Condition
                                            </option>
                                        </select>
                                    </div>

                                    <!-- Price Range Filter -->
                                    <div class="mb-3">
                                        <label class="form-label">Price Range (€)</label>
                                        <div class="row g-2">
                                            <div class="col-6">
                                                <input type="number" class="form-control" id="minPrice" name="minPrice" 
                                                       th:value="${currentMinPrice}" placeholder="Min" min="0" step="0.01">
                                            </div>
                                            <div class="col-6">
                                                <input type="number" class="form-control" id="maxPrice" name="maxPrice" 
                                                       th:value="${currentMaxPrice}" placeholder="Max" min="0" step="0.01">
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            <div id="priceSlider"></div>
                                            <div class="d-flex justify-content-between mt-1">
                                                <small class="text-muted" id="priceMin">€0</small>
                                                <small class="text-muted" id="priceMax">€1000</small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Availability Filter -->
                                    <div class="mb-3">
                                        <label class="form-label">Availability</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="inStock" name="inStock" value="true"
                                                   th:checked="${currentInStock}">
                                            <label class="form-check-label" for="inStock">
                                                In Stock Only
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="lowStock" name="lowStock" value="true"
                                                   th:checked="${currentLowStock}">
                                            <label class="form-check-label" for="lowStock">
                                                Low Stock Alert
                                            </label>
                                        </div>
                                    </div>

                                    <!-- Vendor Filter -->
                                    <div class="mb-3">
                                        <label for="vendorId" class="form-label">Vendor</label>
                                        <select class="form-select" id="vendorId" name="vendorId">
                                            <option value="">All Vendors</option>
                                            <option th:each="vendor : ${vendors}" 
                                                    th:value="${vendor.id}" 
                                                    th:text="${vendor.businessName}"
                                                    th:selected="${vendor.id == currentVendorId}">
                                                Vendor Name
                                            </option>
                                        </select>
                                    </div>

                                    <!-- Sort Options -->
                                    <div class="mb-3">
                                        <label for="sortBy" class="form-label">Sort By</label>
                                        <select class="form-select" id="sortBy" name="sortBy">
                                            <option value="created" th:selected="${currentSortBy == 'created'}">Date Added</option>
                                            <option value="name" th:selected="${currentSortBy == 'name'}">Name</option>
                                            <option value="price" th:selected="${currentSortBy == 'price'}">Price</option>
                                            <option value="popularity" th:selected="${currentSortBy == 'popularity'}">Popularity</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label for="sortDir" class="form-label">Order</label>
                                        <select class="form-select" id="sortDir" name="sortDir">
                                            <option value="desc" th:selected="${currentSortDir == 'desc'}">Descending</option>
                                            <option value="asc" th:selected="${currentSortDir == 'asc'}">Ascending</option>
                                        </select>
                                    </div>

                                    <!-- Search Button -->
                                    <button type="submit" class="btn btn-primary w-100 mb-2">
                                        <i class="fas fa-search"></i> Search
                                    </button>

                                    <!-- Clear Filters -->
                                    <button type="button" class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                                        <i class="fas fa-times"></i> Clear Filters
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Search Results -->
                    <div class="col-lg-9">
                        <!-- Results Header -->
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <h2>Search Results</h2>
                                <p class="text-muted mb-0" th:if="${products != null}">
                                    Found <span th:text="${totalElements}">0</span> results
                                    <span th:if="${currentSearch}" th:text="for '" + ${currentSearch} + "'"></span>
                                </p>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-primary" onclick="toggleFilters()">
                                    <i class="fas fa-filter"></i> Filters
                                </button>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-secondary" onclick="changeView('grid')">
                                        <i class="fas fa-th"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="changeView('list')">
                                        <i class="fas fa-list"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Active Filters Display -->
                        <div th:if="${hasActiveFilters}" class="mb-3">
                            <div class="d-flex flex-wrap gap-2">
                                <span class="badge bg-primary">Active Filters:</span>
                                <span th:if="${currentSearch}" class="badge bg-secondary">
                                    Search: <span th:text="${currentSearch}"></span>
                                    <button type="button" class="btn-close btn-close-white ms-1" 
                                            onclick="removeFilter('q')"></button>
                                </span>
                                <span th:if="${currentCategoryId}" class="badge bg-secondary">
                                    Category: <span th:text="${currentCategoryName}"></span>
                                    <button type="button" class="btn-close btn-close-white ms-1" 
                                            onclick="removeFilter('categoryId')"></button>
                                </span>
                                <span th:if="${currentCondition}" class="badge bg-secondary">
                                    Condition: <span th:text="${currentCondition}"></span>
                                    <button type="button" class="btn-close btn-close-white ms-1" 
                                            onclick="removeFilter('condition')"></button>
                                </span>
                                <span th:if="${currentMinPrice || currentMaxPrice}" class="badge bg-secondary">
                                    Price: €<span th:text="${currentMinPrice ?: '0'}"></span> - €<span th:text="${currentMaxPrice ?: '∞'}"></span>
                                    <button type="button" class="btn-close btn-close-white ms-1" 
                                            onclick="removePriceFilter()"></button>
                                </span>
                            </div>
                        </div>

                        <!-- Loading Spinner -->
                        <div id="loadingSpinner" class="text-center py-5" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Searching...</p>
                        </div>

                        <!-- Results Grid -->
                        <div id="searchResults" th:if="${products != null}">
                            <div class="row" id="productsGrid">
                                <div class="col-md-6 col-lg-4 mb-4" th:each="product : ${products}">
                                    <div class="card product-card h-100">
                                        <div class="position-relative">
                                            <img th:src="${product.primaryImage != null ? product.primaryImage.imageUrl : '/images/no-image.png'}" 
                                                 class="card-img-top product-image" 
                                                 th:alt="${product.name}">
                                            
                                            <span class="badge position-absolute top-0 end-0 m-2" 
                                                  th:classappend="${product.inStock ? 'bg-success' : 'bg-danger'}"
                                                  th:text="${product.inStock ? 'In Stock' : 'Out of Stock'}">
                                                Stock Status
                                            </span>
                                            
                                            <span th:if="${product.lowStock}" class="badge bg-warning position-absolute top-0 start-0 m-2">
                                                <i class="fas fa-exclamation-triangle"></i> Low Stock
                                            </span>
                                        </div>
                                        
                                        <div class="card-body d-flex flex-column">
                                            <h6 class="card-title" th:text="${product.name}">Product Name</h6>
                                            <p class="card-text text-muted small" 
                                               th:text="${#strings.abbreviate(product.description, 80)}">
                                                Product description...
                                            </p>
                                            
                                            <div class="mb-3">
                                                <div class="row text-center">
                                                    <div class="col-6">
                                                        <small class="text-muted d-block">Category</small>
                                                        <strong th:text="${product.category.name}">Category</strong>
                                                    </div>
                                                    <div class="col-6">
                                                        <small class="text-muted d-block">Condition</small>
                                                        <strong th:text="${product.condition.name()}">Condition</strong>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="mt-auto">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span class="price fw-bold" th:text="${product.formattedPrice}">€0.00</span>
                                                    <small class="text-muted" th:text="${product.vendor.businessName}">Vendor</small>
                                                </div>
                                                
                                                <div class="d-flex gap-2">
                                                    <a th:href="@{/products/{id}(id=${product.id})}" 
                                                       class="btn btn-primary btn-sm flex-fill">
                                                        <i class="fas fa-eye"></i> View Details
                                                    </a>
                                                    <button class="btn btn-outline-primary btn-sm" 
                                                            th:onclick="'addToCart(' + ${product.id} + ')'"
                                                            th:disabled="${!product.inStock}">
                                                        <i class="fas fa-cart-plus"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- No Results -->
                            <div th:if="${products.empty}" class="text-center py-5">
                                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                                <h3>No Results Found</h3>
                                <p class="text-muted mb-4">
                                    We couldn't find any products matching your search criteria
                                </p>
                                
                                <div class="row justify-content-center">
                                    <div class="col-md-8">
                                        <h5>Try these suggestions:</h5>
                                        <ul class="list-unstyled">
                                            <li>• Broaden your search terms</li>
                                            <li>• Remove some filters</li>
                                            <li>• Check your spelling</li>
                                            <li>• Try different keywords</li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <div class="mt-4">
                                    <a th:href="@{/products}" class="btn btn-primary me-2">
                                        <i class="fas fa-cogs"></i> Browse All Products
                                    </a>
                                    <a th:href="@{/}" class="btn btn-outline-primary">
                                        <i class="fas fa-home"></i> Back to Home
                                    </a>
                                </div>
                            </div>

                            <!-- Pagination -->
                            <div th:if="${totalPages > 1}" class="d-flex justify-content-center mt-5">
                                <nav aria-label="Advanced search pagination">
                                    <ul class="pagination">
                                        <!-- Previous page -->
                                        <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                                            <a class="page-link" th:if="${currentPage > 0}" 
                                               th:href="@{/products/advanced-search(q=${currentSearch}, categoryId=${currentCategoryId}, condition=${currentCondition}, minPrice=${currentMinPrice}, maxPrice=${currentMaxPrice}, inStock=${currentInStock}, lowStock=${currentLowStock}, vendorId=${currentVendorId}, page=${currentPage - 1}, sortBy=${currentSortBy}, sortDir=${currentSortDir})}">
                                                <i class="fas fa-chevron-left"></i> Previous
                                            </a>
                                            <span class="page-link" th:if="${currentPage == 0}">
                                                <i class="fas fa-chevron-left"></i> Previous
                                            </span>
                                        </li>
                                        
                                        <!-- Page numbers -->
                                        <li class="page-item" th:each="pageNum : ${#numbers.sequence(0, totalPages - 1)}"
                                            th:classappend="${pageNum == currentPage} ? 'active'">
                                            <a class="page-link" th:href="@{/products/advanced-search(q=${currentSearch}, categoryId=${currentCategoryId}, condition=${currentCondition}, minPrice=${currentMinPrice}, maxPrice=${currentMaxPrice}, inStock=${currentInStock}, lowStock=${currentLowStock}, vendorId=${currentVendorId}, page=${pageNum}, sortBy=${currentSortBy}, sortDir=${currentSortDir})}"
                                               th:text="${pageNum + 1}">1</a>
                                        </li>
                                        
                                        <!-- Next page -->
                                        <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
                                            <a class="page-link" th:if="${currentPage < totalPages - 1}" 
                                               th:href="@{/products/advanced-search(q=${currentSearch}, categoryId=${currentCategoryId}, condition=${currentCondition}, minPrice=${currentMinPrice}, maxPrice=${currentMaxPrice}, inStock=${currentInStock}, lowStock=${currentLowStock}, vendorId=${currentVendorId}, page=${currentPage + 1}, sortBy=${currentSortBy}, sortDir=${currentSortDir})}">
                                                Next <i class="fas fa-chevron-right"></i>
                                            </a>
                                            <span class="page-link" th:if="${currentPage == totalPages - 1}">
                                                Next <i class="fas fa-chevron-right"></i>
                                            </span>
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <th:block th:fragment="scripts-extra">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.6.3/nouislider.min.js"></script>
        <script>
            // Price slider initialization
            let priceSlider;
            
            document.addEventListener('DOMContentLoaded', function() {
                initializePriceSlider();
                initializeSearchSuggestions();
            });

            function initializePriceSlider() {
                const slider = document.getElementById('priceSlider');
                if (slider) {
                    priceSlider = noUiSlider.create(slider, {
                        start: [0, 1000],
                        connect: true,
                        range: {
                            'min': 0,
                            'max': 1000
                        },
                        format: {
                            to: function (value) {
                                return Math.round(value);
                            },
                            from: function (value) {
                                return Math.round(value);
                            }
                        }
                    });

                    priceSlider.on('update', function (values, handle) {
                        document.getElementById('priceMin').textContent = '€' + values[0];
                        document.getElementById('priceMax').textContent = '€' + values[1];
                    });

                    priceSlider.on('change', function (values, handle) {
                        document.getElementById('minPrice').value = values[0];
                        document.getElementById('maxPrice').value = values[1];
                    });
                }
            }

            function initializeSearchSuggestions() {
                const searchInput = document.getElementById('searchTerm');
                const suggestionsDiv = document.getElementById('searchSuggestions');
                let debounceTimer;

                searchInput.addEventListener('input', function() {
                    clearTimeout(debounceTimer);
                    const query = this.value.trim();
                    
                    if (query.length < 2) {
                        suggestionsDiv.style.display = 'none';
                        return;
                    }

                    debounceTimer = setTimeout(() => {
                        fetchSearchSuggestions(query);
                    }, 300);
                });

                // Hide suggestions when clicking outside
                document.addEventListener('click', function(e) {
                    if (!searchInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                        suggestionsDiv.style.display = 'none';
                    }
                });
            }

            function fetchSearchSuggestions(query) {
                fetch(`/api/search/suggestions?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        displaySearchSuggestions(data);
                    })
                    .catch(error => {
                        console.error('Error fetching suggestions:', error);
                    });
            }

            function displaySearchSuggestions(suggestions) {
                const suggestionsDiv = document.getElementById('searchSuggestions');
                
                if (suggestions.length === 0) {
                    suggestionsDiv.style.display = 'none';
                    return;
                }

                suggestionsDiv.innerHTML = suggestions.map(suggestion => 
                    `<div class="p-2 border-bottom suggestion-item" onclick="selectSuggestion('${suggestion}')" style="cursor: pointer;">
                        <i class="fas fa-search text-muted me-2"></i>${suggestion}
                    </div>`
                ).join('');
                
                suggestionsDiv.style.display = 'block';
            }

            function selectSuggestion(suggestion) {
                document.getElementById('searchTerm').value = suggestion;
                document.getElementById('searchSuggestions').style.display = 'none';
            }

            function clearFilters() {
                document.getElementById('searchTerm').value = '';
                document.getElementById('categoryId').value = '';
                document.getElementById('condition').value = '';
                document.getElementById('minPrice').value = '';
                document.getElementById('maxPrice').value = '';
                document.getElementById('inStock').checked = false;
                document.getElementById('lowStock').checked = false;
                document.getElementById('vendorId').value = '';
                document.getElementById('sortBy').value = 'created';
                document.getElementById('sortDir').value = 'desc';
                
                if (priceSlider) {
                    priceSlider.set([0, 1000]);
                }
            }

            function toggleFilters() {
                const sidebar = document.querySelector('.col-lg-3');
                sidebar.classList.toggle('d-none');
            }

            function changeView(view) {
                const grid = document.getElementById('productsGrid');
                if (view === 'list') {
                    grid.classList.remove('row');
                    grid.classList.add('list-view');
                } else {
                    grid.classList.remove('list-view');
                    grid.classList.add('row');
                }
            }

            function removeFilter(filterName) {
                const urlParams = new URLSearchParams(window.location.search);
                urlParams.delete(filterName);
                window.location.search = urlParams.toString();
            }

            function removePriceFilter() {
                const urlParams = new URLSearchParams(window.location.search);
                urlParams.delete('minPrice');
                urlParams.delete('maxPrice');
                window.location.search = urlParams.toString();
            }

            function addToCart(productId) {
                // TODO: Implement add to cart functionality
                console.log('Adding product to cart:', productId);
                alert('Product added to cart!');
            }
        </script>
        
        <style>
            .product-card {
                transition: transform 0.2s, box-shadow 0.2s;
                border: none;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }
            .product-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            }
            .product-image {
                height: 200px;
                object-fit: cover;
            }
            .price {
                color: #0d6efd;
                font-size: 1.1rem;
            }
            .suggestion-item:hover {
                background-color: #f8f9fa;
            }
            .sticky-top {
                z-index: 1020;
            }
            .list-view .col-md-6 {
                flex: 0 0 100%;
                max-width: 100%;
            }
            .list-view .product-card {
                flex-direction: row;
            }
            .list-view .product-image {
                width: 200px;
                height: 150px;
            }
            @media (max-width: 991.98px) {
                .sticky-top {
                    position: relative !important;
                    top: 0 !important;
                }
            }
        </style>
    </th:block>
</body>
</html>

